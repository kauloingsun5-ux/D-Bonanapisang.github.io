<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kasir D'bonana Pro - Chart Fixed</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
        :root {
            --primary-color: #4a90e2; --secondary-color: #f5a623; --background-color: #1e1e2e;
            --surface-color: #2a2a3e; --text-color: #e0e0e0; --success-color: #27ae60;
            --danger-color: #e74c3c; --border-radius: 12px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--background-color); color: var(--text-color); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* Header */
        .header { background-color: var(--surface-color); padding: 1rem; display: flex; justify-content: space-between; align-items: center; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .header-actions { display: flex; gap: 0.5rem; }
        .header-btn { background: #3a3a55; color: white; border: none; padding: 0.6rem 1rem; border-radius: 8px; cursor: pointer; font-size: 0.8rem; transition: 0.3s; }
        .header-btn.active { background: var(--primary-color); }

        .main-view { display: none; flex: 1; padding: 1rem; overflow: hidden; gap: 1rem; }
        .main-view.active { display: flex; }
        
        /* Layout Kasir */
        .menu-section { flex: 2; overflow-y: auto; background: var(--surface-color); padding: 1.5rem; border-radius: var(--border-radius); }
        .category-title { font-size: 1rem; font-weight: 600; margin-bottom: 12px; color: var(--secondary-color); border-left: 4px solid var(--secondary-color); padding-left: 10px; text-transform: uppercase; }
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .menu-item { background: var(--background-color); border: 1px solid #3d3d5c; padding: 15px; border-radius: 12px; text-align: center; cursor: pointer; transition: 0.2s; }
        .menu-item:hover { border-color: var(--primary-color); background: #25253a; }

        .order-section { flex: 1; background: var(--surface-color); border-radius: var(--border-radius); display: flex; flex-direction: column; overflow: hidden; }
        .order-items { flex: 1; overflow-y: auto; padding: 1rem; }
        .order-item { display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px solid #444; padding-bottom: 5px; font-size: 0.85rem; }

        /* Report & Chart */
        .report-container { width: 100%; overflow-y: auto; padding: 10px; }
        .chart-box { background: #1a1a2e; padding: 15px; border-radius: 12px; margin-bottom: 20px; height: 260px; border: 1px solid #333; }
        .report-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .report-table th, .report-table td { padding: 12px; text-align: left; border-bottom: 1px solid #444; font-size: 0.8rem; }
        .report-table th { background: #34344d; color: var(--secondary-color); }

        /* Modals */
        .modal { display: none; position: fixed; z-index: 1000; left:0; top:0; width:100%; height:100%; background: rgba(0,0,0,0.9); }
        .modal-content { background: var(--surface-color); margin: 5vh auto; padding: 1.5rem; width: 90%; max-width: 400px; border-radius: var(--border-radius); }
        input, select { width: 100%; padding: 10px; background: #1a1a2e; border: 1px solid #444; color: white; border-radius: 8px; margin-bottom: 10px; }
        .qris-img { width: 100%; max-height: 200px; object-fit: contain; margin-top: 10px; border: 1px dashed #444; display: none; }

        @media (max-width: 768px) { .main-view { flex-direction: column; overflow-y: auto; } .order-section { height: 350px; flex: none; } }
    </style>
</head>
<body>

    <header class="header">
        <h1>D'BONANA <small style="font-size: 0.6rem; color: var(--primary-color);">PRO</small></h1>
        <div class="header-actions">
            <button class="header-btn active" id="btn-cashier" onclick="showView('cashier')">Kasir</button>
            <button class="header-btn" id="btn-report" onclick="showView('report')">Laporan</button>
            <button class="header-btn" onclick="openSettings()"><i class="fas fa-cog"></i></button>
        </div>
    </header>

    <main id="view-cashier" class="main-view active">
        <div class="menu-section" id="menu-display"></div>
        <div class="order-section">
            <div class="order-items" id="order-list"></div>
            <div style="padding: 1.5rem; background: #1a1a2e;">
                <h3 id="total-price" style="color: var(--secondary-color);">Total: Rp 0</h3>
                <button onclick="openPayment()" class="header-btn" style="width:100%; background:var(--success-color); padding: 12px; font-weight: bold; margin-top:10px;">BAYAR</button>
            </div>
        </div>
    </main>

    <main id="view-report" class="main-view">
        <div class="report-container">
            <h2 style="margin-bottom:15px;">Grafik & Laporan Penjualan</h2>
            
            <div class="chart-box">
                <canvas id="salesChart"></canvas>
            </div>

            <table class="report-table">
                <thead>
                    <tr>
                        <th>Hari, Tanggal & Tahun</th>
                        <th>Waktu</th>
                        <th>Total</th>
                        <th>Metode</th>
                    </tr>
                </thead>
                <tbody id="report-body"></tbody>
            </table>
            <br>
            <button onclick="clearData()" style="color:var(--danger-color); background:none; border:none; cursor:pointer; font-size:0.75rem;">Hapus Semua Data</button>
        </div>
    </main>

    <div id="modal-settings" class="modal">
        <div class="modal-content">
            <h3>Pengaturan Toko</h3><br>
            <label style="font-size:0.8rem;">Rekening Bank:</label>
            <input type="text" id="set-bank" placeholder="BCA 123... a/n Nama">
            <label style="font-size:0.8rem;">Upload QRIS:</label>
            <input type="file" id="qris-upload" accept="image/*" onchange="previewQRIS(this)">
            <img id="qris-preview" class="qris-img">
            <button onclick="saveSettings()" class="header-btn" style="width:100%; background:var(--success-color); margin-top:15px;">Simpan</button>
            <button onclick="closeModal('modal-settings')" class="header-btn" style="width:100%; background:none; margin-top:5px;">Tutup</button>
        </div>
    </div>

    <div id="modal-payment" class="modal">
        <div class="modal-content">
            <h3>Metode Pembayaran</h3><br>
            <select id="pay-method" onchange="updatePayInfo()">
                <option value="Tunai">Tunai / Cash</option>
                <option value="Transfer">Transfer Bank</option>
                <option value="QRIS">QRIS</option>
            </select>
            <div id="pay-info" style="margin:10px 0; text-align:center; font-size:0.85rem;"></div>
            <input type="number" id="pay-amount" placeholder="Input Uang Bayar">
            <button onclick="processTransaction()" class="header-btn" style="width:100%; background:var(--success-color); margin-top:10px; padding:12px;">PROSES</button>
            <button onclick="closeModal('modal-payment')" class="header-btn" style="width:100%; background:none; margin-top:5px;">Batal</button>
        </div>
    </div>

    <script>
        const menu = [
            // D'bonana Menu
                { id: 1, category: 'D\'bonana', name: 'Ori', price: 14000, icon: 'fa-star' },
                { id: 2, category: 'D\'bonana', name: 'Susu', price: 15000, icon: 'fa-glass-water' },
                { id: 3, category: 'D\'bonana', name: 'Coklat', price: 18000, icon: 'fa-ice-cream' },
                { id: 4, category: 'D\'bonana', name: 'Keju', price: 18000, icon: 'fa-cheese' },
                { id: 5, category: 'D\'bonana', name: 'Palm Sugar', price: 18000, icon: 'fa-cube' },
                { id: 6, category: 'D\'bonana', name: 'Tiramisu', price: 18000, icon: 'fa-bowl-food' },
                { id: 7, category: 'D\'bonana', name: 'Matcha', price: 18000, icon: 'fa-leaf' },
                { id: 8, category: 'D\'bonana', name: 'Oreo', price: 18000, icon: 'fa-cookie' },
                // D'bonana Mix
                { id: 7, category: 'Mix', name: 'Coklat - Tiramisu', price: 20000, icon: 'fa-blender' },
                { id: 8, category: 'Mix', name: 'Coklat - Oreo', price: 20000, icon: 'fa-blender' },
                { id: 9, category: 'Mix', name: 'Coklat - Matcha', price: 20000, icon: 'fa-blender' },
                { id: 10, category: 'Mix', name: 'Tiramisu - Matcha', price: 20000, icon: 'fa-blender' },
                { id: 11, category: 'Mix', name: 'Tiramisu - Oreo', price: 20000, icon: 'fa-blender' },
                { id: 12, category: 'Mix', name: 'Matcha - Oreo', price: 20000, icon: 'fa-blender' },
                { id: 13, category: 'Mix', name: 'palm-matcha', price: 20000, icon: 'fa-blender' },
                { id: 14, category: 'Mix', name: 'palm-coklat', price: 20000, icon: 'fa-blender' },
                { id: 15, category: 'Mix', name: 'palm-tiramisu', price: 20000, icon: 'fa-blender' },
                { id: 16, category: 'Mix', name: 'palm-oreo', price: 20000, icon: 'fa-blender' },
                { id: 17, category: 'Mix', name: 'Keju - Coklat', price: 23000, icon: 'fa-blender' },
                { id: 18, category: 'Mix', name: 'Keju - Tiramisu', price: 23000, icon: 'fa-blender' },
                { id: 19, category: 'Mix', name: 'Keju - Matcha', price: 23000, icon: 'fa-blender' },
                { id: 20, category: 'Mix', name: 'Keju - Oreo', price: 23000, icon: 'fa-blender' },
                { id: 21, category: 'Mix', name: 'keju-palm', price: 23000, icon: 'fa-blender' },
                                 
                // Ketan Susu Menu
                { id: 22, category: 'Ketan Susu', name: 'Ketan Susu Original', price: 10000, icon: 'fa-bowl-rice' },
                { id: 23, category: 'Ketan Susu', name: 'Ketan Coklat', price: 13000, icon: 'fa-ice-cream' },
                { id: 24, category: 'Ketan Susu', name: 'Ketan Keju', price: 13000, icon: 'fa-cheese' },
                { id: 25, category: 'Ketan Susu', name: 'Ketan Palm Sugar', price: 13000, icon: 'fa-cube' },
                { id: 26, category: 'Ketan Susu', name: 'Ketan Tiramisu', price: 13000, icon: 'fa-bowl-food' },
                { id: 27, category: 'Ketan Susu', name: 'Ketan Matcha', price: 13000, icon: 'fa-leaf' },
                { id: 28, category: 'Ketan Susu', name: 'Ketan Oreo', price: 13000, icon: 'fa-cookie' },
                // Ketan Susu Mix
                { id: 29, category: 'Ketan Susu Mix', name: 'Coklat - Keju', price: 15000, icon: 'fa-blender' },
                { id: 30, category: 'Ketan Susu Mix', name: 'Coklat - Oreo', price: 15000, icon: 'fa-blender' },
                { id: 31, category: 'Ketan Susu Mix', name: 'Coklat - Matcha', price: 15000, icon: 'fa-blender' },
                { id: 32, category: 'Ketan Susu Mix', name: 'Coklat - Tiramisu', price: 15000, icon: 'fa-blender' },
                { id: 33, category: 'Ketan Susu Mix', name: 'Coklat - Palm Sugar', price: 15000, icon: 'fa-blender' },
                { id: 34, category: 'Ketan Susu Mix', name: 'Keju - Tiramisu', price: 15000, icon: 'fa-blender' },
                { id: 35, category: 'Ketan Susu Mix', name: 'Keju - Oreo', price: 15000, icon: 'fa-blender' },
                { id: 36, category: 'Ketan Susu Mix', name: 'Keju - Matcha', price: 15000, icon: 'fa-blender' },
                { id: 37, category: 'Ketan Susu Mix', name: 'Keju - Palm Sugar', price: 15000, icon: 'fa-blender' },
                { id: 38, category: 'Ketan Susu Mix', name: 'Matcha - Oreo', price: 15000, icon: 'fa-blender' },
                { id: 39, category: 'Ketan Susu Mix', name: 'Matcha - Palm Sugar', price: 15000, icon: 'fa-blender' },
                { id: 40, category: 'Ketan Susu Mix', name: 'Oreo - Palm Sugar', price: 15000, icon: 'fa-blender' },
                { id: 41, category: 'Ketan Susu Mix', name: 'Palm Sugar - Tiramisu', price: 15000, icon: 'fa-blender' },
                  
            ];


        let cart = [];
        let sales = JSON.parse(localStorage.getItem('sales_db')) || [];
        let config = JSON.parse(localStorage.getItem('config_db')) || { bank: "", qris: "" };
        let myChart = null;

        function showView(view) {
            document.querySelectorAll('.main-view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.header-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('view-' + view).classList.add('active');
            document.getElementById('btn-' + view).classList.add('active');
            
            if(view === 'report') {
                renderReport(); // Memanggil render tabel & grafik
            }
        }

        function renderMenu() {
            const display = document.getElementById('menu-display');
            display.innerHTML = '<div class="category-title">Menu Favorit</div><div class="menu-grid"></div>';
            const grid = display.querySelector('.menu-grid');
            menu.forEach(item => {
                grid.innerHTML += `<div class="menu-item" onclick="addToCart(${item.id})"><div>${item.name}</div><div style="color:var(--secondary-color); font-weight:bold;">Rp ${item.price.toLocaleString()}</div></div>`;
            });
        }

        function addToCart(id) {
            const item = menu.find(m => m.id === id);
            const exist = cart.find(c => c.id === id);
            if(exist) exist.qty++; else cart.push({...item, qty: 1});
            renderCart();
        }

        function renderCart() {
            const list = document.getElementById('order-list');
            list.innerHTML = ''; let total = 0;
            cart.forEach(item => { total += item.price * item.qty; list.innerHTML += `<div class="order-item"><span>${item.qty}x ${item.name}</span><span>Rp ${(item.price*item.qty).toLocaleString()}</span></div>`; });
            document.getElementById('total-price').innerText = `Total: Rp ${total.toLocaleString()}`;
        }

        // FUNGSI UTAMA UNTUK TABEL DAN GRAFIK
        function renderReport() {
            const body = document.getElementById('report-body');
            body.innerHTML = '';
            let chartLabels = [], chartData = [];
            const listHari = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];

            sales.slice(-10).forEach(s => {
                const d = new Date(s.time);
                const hari = listHari[d.getDay()];
                const tgl = d.toLocaleDateString('id-ID', { day:'2-digit', month:'short', year:'numeric' });
                const jam = d.toLocaleTimeString('id-ID', { hour:'2-digit', minute:'2-digit' });

                body.innerHTML = `<tr><td>${hari}, ${tgl}</td><td>${jam} WIB</td><td>Rp ${s.total.toLocaleString()}</td><td>${s.method}</td></tr>` + body.innerHTML;
                
                chartLabels.push(jam);
                chartData.push(s.total);
            });

            updateChart(chartLabels, chartData);
        }

        function updateChart(labels, data) {
            const ctx = document.getElementById('salesChart').getContext('2d');
            if(myChart) myChart.destroy();

            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Omzet per Transaksi',
                        data: data,
                        backgroundColor: '#4a90e2',
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { 
                        y: { beginAtZero: true, grid: { color: '#333' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function processTransaction() {
            if(cart.length === 0) return;
            const total = cart.reduce((a,b) => a + (b.price * b.qty), 0);
            sales.push({ time: new Date().getTime(), total: total, method: document.getElementById('pay-method').value });
            localStorage.setItem('sales_db', JSON.stringify(sales));
            cart = []; renderCart(); closeModal('modal-payment');
            alert('Transaksi Berhasil!');
        }

        function previewQRIS(input) {
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('qris-preview').src = e.target.result;
                document.getElementById('qris-preview').style.display = 'block';
                config.qris = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        }

        function saveSettings() {
            config.bank = document.getElementById('set-bank').value;
            localStorage.setItem('config_db', JSON.stringify(config));
            closeModal('modal-settings');
        }

        function openSettings() { 
            document.getElementById('modal-settings').style.display = 'block'; 
            document.getElementById('set-bank').value = config.bank;
            if(config.qris) {
                document.getElementById('qris-preview').src = config.qris;
                document.getElementById('qris-preview').style.display = 'block';
            }
        }
        function openPayment() { if(cart.length > 0) document.getElementById('modal-payment').style.display = 'block'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function clearData() { if(confirm('Hapus laporan?')) { sales = []; localStorage.removeItem('sales_db'); renderReport(); } }

        renderMenu();
    </script>
</body>
</html>

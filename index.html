<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kasir D'bonana Pro - Final Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
        :root {
            --primary-color: #4a90e2; --secondary-color: #f5a623; --background-color: #1e1e2e;
            --surface-color: #2a2a3e; --text-color: #e0e0e0; --success-color: #27ae60;
            --danger-color: #e74c3c; --border-radius: 12px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--background-color); color: var(--text-color); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* Header */
        .header { background-color: var(--surface-color); padding: 1rem; display: flex; justify-content: space-between; align-items: center; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .header-actions { display: flex; gap: 0.5rem; }
        .header-btn { background: #3a3a55; color: white; border: none; padding: 0.6rem 1rem; border-radius: 8px; cursor: pointer; font-size: 0.8rem; transition: 0.3s; }
        .header-btn.active { background: var(--primary-color); }

        .main-view { display: none; flex: 1; padding: 1rem; overflow: hidden; gap: 1rem; }
        .main-view.active { display: flex; }
        
        /* Menu Layout */
        .menu-section { flex: 2; overflow-y: auto; background: var(--surface-color); padding: 1.5rem; border-radius: var(--border-radius); }
        .category-group { margin-bottom: 25px; }
        .category-title { font-size: 1rem; font-weight: 600; margin-bottom: 12px; color: var(--secondary-color); border-left: 4px solid var(--secondary-color); padding-left: 10px; text-transform: uppercase; }
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 12px; }
        .menu-item { background: var(--background-color); border: 1px solid #3d3d5c; padding: 15px; border-radius: 12px; text-align: center; cursor: pointer; transition: 0.2s; }
        .menu-item:hover { border-color: var(--primary-color); background: #25253a; transform: translateY(-3px); }

        /* Keranjang Pesanan */
        .order-section { flex: 1; background: var(--surface-color); border-radius: var(--border-radius); display: flex; flex-direction: column; overflow: hidden; }
        .order-header { padding: 10px 15px; background: #34344d; display: flex; justify-content: space-between; align-items: center; font-weight: 600; font-size: 0.9rem; }
        .order-items { flex: 1; overflow-y: auto; padding: 1rem; }
        .order-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; border-bottom: 1px solid #444; padding-bottom: 8px; }
        .item-info { flex: 1; font-size: 0.85rem; }
        .btn-delete-item { color: var(--danger-color); background: none; border: none; cursor: pointer; padding: 5px 10px; font-size: 1rem; }

        /* Report & Chart */
        .report-container { width: 100%; height: 100%; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; }
        
        /* Stats Cards */
        .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: linear-gradient(135deg, var(--surface-color), #34344d); padding: 20px; border-radius: var(--border-radius); border: 1px solid #3d3d5c; text-align: center; transition: transform 0.3s; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .stat-icon { font-size: 2rem; margin-bottom: 10px; }
        .stat-value { font-size: 1.8rem; font-weight: 700; margin-bottom: 5px; }
        .stat-label { font-size: 0.8rem; color: #aaa; text-transform: uppercase; }
        .stat-card:nth-child(1) .stat-icon { color: var(--success-color); }
        .stat-card:nth-child(2) .stat-icon { color: var(--primary-color); }
        .stat-card:nth-child(3) .stat-icon { color: var(--secondary-color); }
        
        .chart-box { background: #1a1a2e; padding: 15px; border-radius: 12px; margin-bottom: 20px; height: 300px; width: 100%; border: 1px solid #333; position: relative; }
        .chart-container { position: relative; height: 100%; width: 100%; }
        .report-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .report-table th, .report-table td { padding: 12px; text-align: left; border-bottom: 1px solid #444; }

        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1000; left:0; top:0; width:100%; height:100%; background: rgba(0,0,0,0.9); }
        .modal-content { background: var(--surface-color); margin: 5vh auto; padding: 1.5rem; width: 90%; max-width: 400px; border-radius: var(--border-radius); max-height: 90vh; overflow-y: auto; }
        input, select { width: 100%; padding: 12px; background: #1a1a2e; border: 1px solid #444; color: white; border-radius: 8px; margin-bottom: 15px; }

        /* Struk Style */
        .receipt-card { background: white; color: black; padding: 25px; font-family: 'Courier New', monospace; border-radius: 4px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .receipt-header { text-align: center; border-bottom: 1px dashed black; padding-bottom: 10px; margin-bottom: 10px; }
        .receipt-line { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 4px; }

        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; box-shadow: none; }
        }
        @media (max-width: 768px) { 
            .main-view { flex-direction: column; overflow-y: auto; } 
            .order-section { height: 350px; flex: none; }
            .stats-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <header class="header">
        <h1>D'BONANA <small style="font-size: 0.6rem; color: var(--primary-color);">PRO</small></h1>
        <div class="header-actions">
            <button class="header-btn active" id="btn-cashier" onclick="showView('cashier')">Kasir</button>
            <button class="header-btn" id="btn-report" onclick="showView('report')">Laporan</button>
            <button class="header-btn" onclick="openSettings()"><i class="fas fa-cog"></i></button>
        </div>
    </header>

    <main id="view-cashier" class="main-view active">
        <div class="menu-section" id="menu-display"></div>
        <div class="order-section">
            <div class="order-header">
                <span>PESANAN</span>
                <button onclick="clearCart()" style="background:none; border:none; color:var(--danger-color); font-size:0.7rem; cursor:pointer; font-weight:bold;">RESET</button>
            </div>
            <div class="order-items" id="order-list"></div>
            <div style="padding: 1.2rem; background: #1a1a2e; border-top: 1px solid #333;">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <span style="font-size:0.8rem; color:#aaa;">TOTAL BAYAR</span>
                    <h3 id="total-price" style="color: var(--secondary-color);">Rp 0</h3>
                </div>
                <button onclick="openPayment()" class="header-btn" style="width:100%; background:var(--success-color); padding: 14px; font-weight: bold; font-size:1rem;">PROSES BAYAR</button>
            </div>
        </div>
    </main>

    <main id="view-report" class="main-view">
        <div class="report-container">
            <!-- Stats Cards -->
            <div class="stats-container">
                <div class="stat-card">
                    <i class="fas fa-money-bill-wave stat-icon"></i>
                    <div class="stat-value" id="stat-income">Rp 0</div>
                    <div class="stat-label">Total Pendapatan</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-chart-line stat-icon"></i>
                    <div class="stat-value" id="stat-omzet">Rp 0</div>
                    <div class="stat-label">Omzet Hari Ini</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-box stat-icon"></i>
                    <div class="stat-value" id="stat-boxes">0</div>
                    <div class="stat-label">Total Box Terjual</div>
                </div>
            </div>
            
            <div class="chart-box">
                <div class="chart-container">
                    <canvas id="salesChart"></canvas>
                </div>
            </div>
            <table class="report-table">
                <thead><tr><th>Waktu Transaksi</th><th>Total</th><th>Metode</th></tr></thead>
                <tbody id="report-body"></tbody>
            </table>
            <br><button onclick="clearSalesData()" style="color:var(--danger-color); background:none; border:none; font-size:0.7rem; cursor:pointer;"><i class="fas fa-trash"></i> Reset Data Laporan</button>
        </div>
    </main>

    <div id="modal-settings" class="modal">
        <div class="modal-content">
            <h3><i class="fas fa-store"></i> Pengaturan Toko</h3><br>
            <label style="font-size:0.8rem;">Nama Toko di Struk:</label>
            <input type="text" id="set-name" placeholder="Contoh: D'Bonana Jogja">
            <label style="font-size:0.8rem;">Alamat Lengkap:</label>
            <input type="text" id="set-addr" placeholder="Contoh: Jl. Diponegoro No. 123">
            <label style="font-size:0.8rem;">Info Rekening (Transfer):</label>
            <input type="text" id="set-bank" placeholder="BCA 12345 a/n Nama">
            <label style="font-size:0.8rem;">URL Foto QRIS (Opsional):</label>
            <input type="text" id="set-qris" placeholder="https://link-gambar.com/qris.jpg">
            <button onclick="saveSettings()" class="header-btn" style="width:100%; background:var(--success-color); margin-top:10px; padding:12px;">SIMPAN PERUBAHAN</button>
            <button onclick="closeModal('modal-settings')" class="header-btn" style="width:100%; background:none;">Tutup</button>
        </div>
    </div>

    <div id="modal-payment" class="modal">
        <div class="modal-content">
            <h3><i class="fas fa-wallet"></i> Pembayaran</h3><br>
            <select id="pay-method" onchange="updatePayInfo()">
                <option value="Tunai">Tunai / Cash</option>
                <option value="Transfer">Transfer Bank</option>
                <option value="QRIS">QRIS</option>
            </select>
            <div id="pay-info" style="margin:10px 0; text-align:center; font-size:0.85rem; background:#1a1a2e; padding:10px; border-radius:8px; border:1px solid #333;"></div>
            <input type="number" id="pay-amount" placeholder="Jumlah Uang Diterima">
            <button onclick="processTransaction()" class="header-btn" style="width:100%; background:var(--success-color); padding:14px; font-weight:bold;">SELESAIKAN</button>
            <button onclick="closeModal('modal-payment')" class="header-btn" style="width:100%; background:none;">Batal</button>
        </div>
    </div>

    <div id="modal-receipt" class="modal">
        <div class="modal-content" style="max-width:350px;">
            <div id="print-area" class="receipt-card">
                <div class="receipt-header">
                    <strong id="st-name" style="font-size:1.2rem;">D'BONANA</strong><br>
                    <small id="st-addr">Alamat Toko</small>
                </div>
                <div id="st-items" style="margin:10px 0;"></div>
                <div style="border-top:1px dashed black; margin-top:10px; padding-top:10px;">
                    <div class="receipt-line"><strong>TOTAL</strong><strong id="st-total"></strong></div>
                    <div class="receipt-line"><span>Metode</span><span id="st-method"></span></div>
                </div>
                <div style="text-align:center; margin-top:20px; font-size:0.7rem; color:#666;">
                    --- TERIMA KASIH ---
                </div>
            </div>
            <br>
            <button onclick="window.print()" class="header-btn" style="width:100%; background:var(--primary-color); margin-bottom:10px;">
                <i class="fas fa-print"></i> CETAK STRUK
            </button>
            <button onclick="sendWA()" class="header-btn" style="width:100%; background:#25d366; margin-bottom:10px;">
                <i class="fab fa-whatsapp"></i> KIRIM WHATSAPP
            </button>
            <button onclick="closeModal('modal-receipt')" class="header-btn" style="width:100%; background:none; border:1px solid #444;">SELESAI</button>
        </div>
    </div>

    <script>
        const menu = [
             // D'bonana Menu
                { id: 1, category: 'D\'bonana', name: 'Ori', price: 14000, icon: 'fa-star' },
                { id: 2, category: 'D\'bonana', name: 'Susu', price: 15000, icon: 'fa-glass-water' },
                { id: 3, category: 'D\'bonana', name: 'Coklat', price: 18000, icon: 'fa-ice-cream' },
                { id: 4, category: 'D\'bonana', name: 'Keju', price: 18000, icon: 'fa-cheese' },
                { id: 5, category: 'D\'bonana', name: 'Palm Sugar', price: 18000, icon: 'fa-cube' },
                { id: 6, category: 'D\'bonana', name: 'Tiramisu', price: 18000, icon: 'fa-bowl-food' },
                { id: 7, category: 'D\'bonana', name: 'Matcha', price: 18000, icon: 'fa-leaf' },
                { id: 8, category: 'D\'bonana', name: 'Oreo', price: 18000, icon: 'fa-cookie' },
                // D'bonana Mix
                { id: 9, category: 'Mix', name: 'Coklat - Tiramisu', price: 20000, icon: 'fa-blender' },
                { id: 10, category: 'Mix', name: 'Coklat - Oreo', price: 20000, icon: 'fa-blender' },
                { id: 11, category: 'Mix', name: 'Coklat - Matcha', price: 20000, icon: 'fa-blender' },
                { id: 12, category: 'Mix', name: 'Tiramisu - Matcha', price: 20000, icon: 'fa-blender' },
                { id: 13, category: 'Mix', name: 'Tiramisu - Oreo', price: 20000, icon: 'fa-blender' },
                { id: 14, category: 'Mix', name: 'Matcha - Oreo', price: 20000, icon: 'fa-blender' },
                { id: 15, category: 'Mix', name: 'palm-matcha', price: 20000, icon: 'fa-blender' },
                { id: 16, category: 'Mix', name: 'palm-coklat', price: 20000, icon: 'fa-blender' },
                { id: 17, category: 'Mix', name: 'palm-tiramisu', price: 20000, icon: 'fa-blender' },
                { id: 18, category: 'Mix', name: 'palm-oreo', price: 20000, icon: 'fa-blender' },
                { id: 19, category: 'Mix', name: 'Keju - Coklat', price: 23000, icon: 'fa-blender' },
                { id: 20, category: 'Mix', name: 'Keju - Tiramisu', price: 23000, icon: 'fa-blender' },
                { id: 21, category: 'Mix', name: 'Keju - Matcha', price: 23000, icon: 'fa-blender' },
                { id: 22, category: 'Mix', name: 'Keju - Oreo', price: 23000, icon: 'fa-blender' },
                { id: 23, category: 'Mix', name: 'keju-palm', price: 23000, icon: 'fa-blender' },
                                 
                // Ketan Susu Menu
                { id: 24, category: 'Ketan Susu', name: 'Ketan Susu Original', price: 10000, icon: 'fa-bowl-rice' },
                { id: 25, category: 'Ketan Susu', name: 'Ketan Coklat', price: 13000, icon: 'fa-ice-cream' },
                { id: 26, category: 'Ketan Susu', name: 'Ketan Keju', price: 13000, icon: 'fa-cheese' },
                { id: 27, category: 'Ketan Susu', name: 'Ketan Palm Sugar', price: 13000, icon: 'fa-cube' },
                { id: 28, category: 'Ketan Susu', name: 'Ketan Tiramisu', price: 13000, icon: 'fa-bowl-food' },
                { id: 29, category: 'Ketan Susu', name: 'Ketan Matcha', price: 13000, icon: 'fa-leaf' },
                { id: 30, category: 'Ketan Susu', name: 'Ketan Oreo', price: 13000, icon: 'fa-cookie' },
                // Ketan Susu Mix
                { id: 31, category: 'Ketan Susu Mix', name: 'Coklat - Keju', price: 15000, icon: 'fa-blender' },
                { id: 32, category: 'Ketan Susu Mix', name: 'Coklat - Oreo', price: 15000, icon: 'fa-blender' },
                { id: 33, category: 'Ketan Susu Mix', name: 'Coklat - Matcha', price: 15000, icon: 'fa-blender' },
                { id: 34, category: 'Ketan Susu Mix', name: 'Coklat - Tiramisu', price: 15000, icon: 'fa-blender' },
                { id: 35, category: 'Ketan Susu Mix', name: 'Coklat - Palm Sugar', price: 15000, icon: 'fa-blender' },
                { id: 36, category: 'Ketan Susu Mix', name: 'Keju - Tiramisu', price: 15000, icon: 'fa-blender' },
                { id: 37, category: 'Ketan Susu Mix', name: 'Keju - Oreo', price: 15000, icon: 'fa-blender' },
                { id: 38, category: 'Ketan Susu Mix', name: 'Keju - Matcha', price: 15000, icon: 'fa-blender' },
                { id: 39, category: 'Ketan Susu Mix', name: 'Keju - Palm Sugar', price: 15000, icon: 'fa-blender' },
                { id: 40, category: 'Ketan Susu Mix', name: 'Matcha - Oreo', price: 15000, icon: 'fa-blender' },
                { id: 41, category: 'Ketan Susu Mix', name: 'Matcha - Palm Sugar', price: 15000, icon: 'fa-blender' },
                { id: 42, category: 'Ketan Susu Mix', name: 'Oreo - Palm Sugar', price: 15000, icon: 'fa-blender' },
                { id: 43, category: 'Ketan Susu Mix', name: 'Palm Sugar - Tiramisu', price: 15000, icon: 'fa-blender' },
                  
            ];


        let cart = [];
        let sales = JSON.parse(localStorage.getItem('sales_db')) || [];
        let config = JSON.parse(localStorage.getItem('config_db')) || { name: "D'BONANA", addr: "Jl. Kasir No. 1", bank: "-", qris: "" };
        let myChart = null;
        let lastTrx = null;

        function renderMenu() {
            const display = document.getElementById('menu-display');
            display.innerHTML = '';
            const categories = [...new Set(menu.map(item => item.category))];
            categories.forEach(cat => {
                let html = `<div class="category-group"><div class="category-title">${cat}</div><div class="menu-grid">`;
                menu.filter(i => i.category === cat).forEach(item => {
                    html += `<div class="menu-item" onclick="addToCart(${item.id})">
                        <i class="fas ${item.icon}" style="color:var(--primary-color); font-size:1.5rem; margin-bottom:10px;"></i><br>
                        <small>${item.name}</small><br><strong>Rp ${item.price.toLocaleString()}</strong>
                    </div>`;
                });
                display.innerHTML += html + `</div></div>`;
            });
        }

        function addToCart(id) {
            const item = menu.find(m => m.id === id);
            const exist = cart.find(c => c.id === id);
            if(exist) exist.qty++; else cart.push({...item, qty: 1});
            renderCart();
        }

        function removeFromCart(id) {
            cart = cart.filter(item => item.id !== id);
            renderCart();
        }

        function clearCart() { if(confirm('Kosongkan keranjang?')) { cart = []; renderCart(); } }

        function renderCart() {
            const list = document.getElementById('order-list');
            list.innerHTML = ''; let total = 0;
            cart.forEach(item => {
                total += item.price * item.qty;
                list.innerHTML += `<div class="order-item">
                    <div class="item-info">
                        <strong>${item.name}</strong><br>
                        <small>${item.qty}x @ Rp ${item.price.toLocaleString()}</small>
                    </div>
                    <div style="font-weight:bold; margin-right:10px;">Rp ${(item.price*item.qty).toLocaleString()}</div>
                    <button class="btn-delete-item" onclick="removeFromCart(${item.id})"><i class="fas fa-trash-alt"></i></button>
                </div>`;
            });
            document.getElementById('total-price').innerText = `Rp ${total.toLocaleString()}`;
        }

        function processTransaction() {
            if(cart.length === 0) return;
            const total = cart.reduce((a,b) => a + (b.price * b.qty), 0);
            const now = new Date();
            const timeStr = now.toLocaleDateString('id-ID') + ' ' + now.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});
            
            lastTrx = { time: timeStr, items: [...cart], total: total, method: document.getElementById('pay-method').value };
            sales.push(lastTrx);
            localStorage.setItem('sales_db', JSON.stringify(sales));
            
            // Siapkan Struk Digital
            document.getElementById('st-name').innerText = config.name;
            document.getElementById('st-addr').innerText = config.addr;
            document.getElementById('st-total').innerText = `Rp ${total.toLocaleString()}`;
            document.getElementById('st-method').innerText = lastTrx.method;
            let itemsHtml = '';
            lastTrx.items.forEach(i => { itemsHtml += `<div class="receipt-line"><span>${i.qty}x ${i.name}</span><span>${(i.qty*i.price).toLocaleString()}</span></div>`; });
            document.getElementById('st-items').innerHTML = itemsHtml;

            cart = []; renderCart();
            closeModal('modal-payment');
            document.getElementById('modal-receipt').style.display = 'block';
        }

        function updateSalesChart(labels, data) {
            const ctx = document.getElementById('salesChart').getContext('2d');
            
            // Destroy previous chart if exists
            if(myChart) {
                myChart.destroy();
                myChart = null;
            }
            
            // Create new chart
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Omzet per Transaksi',
                        data: data,
                        borderColor: '#4a90e2',
                        backgroundColor: 'rgba(74, 144, 226, 0.2)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 3,
                        pointBackgroundColor: '#f5a623',
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#e0e0e0',
                                font: {
                                    family: 'Poppins'
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#e0e0e0',
                            bodyColor: '#e0e0e0',
                            borderColor: '#4a90e2',
                            borderWidth: 1
                        }
                    },
                    scales: { 
                        y: { 
                            beginAtZero: true, 
                            grid: { color: '#333' },
                            ticks: {
                                color: '#e0e0e0',
                                callback: function(value) {
                                    return 'Rp ' + value.toLocaleString();
                                }
                            }
                        }, 
                        x: { 
                            grid: { display: false },
                            ticks: {
                                color: '#e0e0e0'
                            }
                        } 
                    }
                }
            });
        }

        function calculateStats() {
            let totalIncome = 0;
            let todayIncome = 0;
            let totalBoxes = 0;
            const today = new Date().toLocaleDateString('id-ID');
            
            sales.forEach(sale => {
                // Total income from all sales
                totalIncome += sale.total;
                
                // Check if sale is from today
                if(sale.time.includes(today)) {
                    todayIncome += sale.total;
                }
                
                // Count total boxes/items sold
                sale.items.forEach(item => {
                    totalBoxes += item.qty;
                });
            });
            
            // Update the stat cards
            document.getElementById('stat-income').innerText = `Rp ${totalIncome.toLocaleString()}`;
            document.getElementById('stat-omzet').innerText = `Rp ${todayIncome.toLocaleString()}`;
            document.getElementById('stat-boxes').innerText = totalBoxes.toLocaleString();
        }

        function renderReport() {
            const body = document.getElementById('report-body');
            body.innerHTML = ''; 
            if(sales.length === 0) { 
                body.innerHTML = '<tr><td colspan="3" style="text-align:center">Belum ada data</td></tr>';
                if(myChart) {
                    myChart.destroy();
                    myChart = null;
                }
                // Reset stats
                document.getElementById('stat-income').innerText = 'Rp 0';
                document.getElementById('stat-omzet').innerText = 'Rp 0';
                document.getElementById('stat-boxes').innerText = '0';
                return; 
            }
            
            // Calculate and update statistics
            calculateStats();
            
            let labels = [], data = [];
            const lastData = sales.slice(-12); // Ambil 12 data terakhir
            lastData.forEach(s => {
                body.innerHTML = `<tr><td>${s.time}</td><td style="color:var(--success-color); font-weight:bold;">Rp ${s.total.toLocaleString()}</td><td>${s.method}</td></tr>` + body.innerHTML;
                const timeLabel = s.time.split(' ')[1];
                labels.push(timeLabel); 
                data.push(s.total);
            });
            
            // Use setTimeout to ensure DOM is ready before rendering chart
            setTimeout(() => {
                updateSalesChart(labels, data);
            }, 100);
        }

        function sendWA() {
            let msg = `*${config.name}*\n${config.addr}\n--------------------\n`;
            lastTrx.items.forEach(i => { msg += `${i.qty}x ${i.name} = Rp ${(i.qty*i.price).toLocaleString()}\n`; });
            msg += `--------------------\n*TOTAL: Rp ${lastTrx.total.toLocaleString()}*\nMetode: ${lastTrx.method}\n\nTerima Kasih!`;
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
        }

        function openSettings() {
            document.getElementById('modal-settings').style.display = 'block';
            document.getElementById('set-name').value = config.name;
            document.getElementById('set-addr').value = config.addr;
            document.getElementById('set-bank').value = config.bank;
            document.getElementById('set-qris').value = config.qris;
        }

        function saveSettings() {
            config.name = document.getElementById('set-name').value || "D'BONANA";
            config.addr = document.getElementById('set-addr').value || "Alamat Toko";
            config.bank = document.getElementById('set-bank').value || "-";
            config.qris = document.getElementById('set-qris').value || "";
            localStorage.setItem('config_db', JSON.stringify(config));
            closeModal('modal-settings');
            alert('Pengaturan Berhasil Disimpan!');
        }

        function updatePayInfo() {
            const m = document.getElementById('pay-method').value;
            const info = document.getElementById('pay-info');
            if(m === 'Transfer') info.innerText = "Rek: " + (config.bank);
            else if(m === 'QRIS') info.innerHTML = config.qris ? `<img src="${config.qris}" width="120">` : "Scan QRIS di Kasir";
            else info.innerText = "Bayar Tunai di Kasir";
        }

        function showView(v) {
            document.querySelectorAll('.main-view, .header-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('view-'+v).classList.add('active');
            document.getElementById('btn-'+v).classList.add('active');
            if(v === 'report') {
                // Use longer timeout to ensure the view is fully rendered
                setTimeout(() => {
                    renderReport();
                }, 200);
            }
        }

        function openPayment() { if(cart.length > 0) { document.getElementById('modal-payment').style.display = 'block'; updatePayInfo(); } }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function clearSalesData() { 
            if(confirm('Hapus semua data laporan?')) { 
                sales = []; 
                localStorage.removeItem('sales_db'); 
                renderReport(); 
            } 
        }

        window.onload = function() {
            renderMenu();
            // Initialize chart with empty data to prevent errors
            const ctx = document.getElementById('salesChart');
            if(ctx) {
                updateSalesChart([], []);
            }
        };
    </script>
</body>
</html>
